# GitLab CI/CD Pipeline for {{project_name}} Python Package
# Generated by PipeOps CLI on {{creation_date}}

stages:
  - test
  - build
  - publish

variables:
  PACKAGE_NAME: {{project_name}}

test:
  stage: test
  image: python:3.9-slim
  before_script:
    - pip install --upgrade pip
    - pip install -e . || echo "No setup.py found"
    - pip install pytest pytest-cov flake8 || echo "Installing test dependencies"
  script:
    - python -m pytest tests/ -v || echo "No tests found"
    - python -m flake8 {{project_name}}/ || echo "No source directory found"
  only:
    - main
    - develop
    - merge_requests

build:
  stage: build
  image: python:3.9-slim
  before_script:
    - pip install build twine
  script:
    - python -m build
    - python -m twine check dist/*
  artifacts:
    paths:
      - dist/
    expire_in: 1 week
  only:
    - main
    - develop
    - tags

publish-pypi:
  stage: publish
  image: python:3.9-slim
  before_script:
    - pip install twine
  script:
    - python -m twine upload dist/* --username __token__ --password $PYPI_TOKEN
  dependencies:
    - build
  when: manual
  only:
    - tags
